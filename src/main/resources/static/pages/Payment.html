<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Skincare Booking - Payment</title>
  <style>
    :root {
      --primary-color: #6a8d92;
      --secondary-color: #f5f5f5;
      --accent-color: #e8a87c;
      --text-color: #333;
      --success-color: #4CAF50;
      --error-color: #f44336;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f9f9f9;
      color: var(--text-color);
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    header {
      background-color: var(--primary-color);
      color: white;
      padding: 15px 0;
      text-align: center;
      border-radius: 5px 5px 0 0;
    }
    .payment-form {
      background-color: white;
      padding: 30px;
      border-radius: 5px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      margin-top: 20px;
    }
    .form-group {
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
    }
    input, select {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
      transition: border-color 0.3s;
    }
    input:focus, select:focus {
      border-color: var(--primary-color);
      outline: none;
    }
    .payment-methods {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 20px;
    }
    .payment-method {
      flex: 1;
      min-width: 120px;
      text-align: center;
      padding: 15px;
      border: 2px solid #ddd;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .payment-method:hover {
      border-color: var(--primary-color);
    }
    .payment-method.selected {
      border-color: var(--primary-color);
      background-color: rgba(106, 141, 146, 0.1);
    }
    .payment-method img {
      height: 40px;
      margin-bottom: 10px;
    }
    .btn {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 14px 20px;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
      width: 100%;
      transition: background-color 0.3s;
    }
    .btn:hover {
      background-color: #5a7d82;
    }
    .summary {
      background-color: var(--secondary-color);
      padding: 20px;
      border-radius: 5px;
      margin-bottom: 20px;
    }
    .summary h3 {
      margin-top: 0;
      border-bottom: 1px solid #ddd;
      padding-bottom: 10px;
    }
    .summary-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .total {
      font-weight: bold;
      font-size: 18px;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #ddd;
    }
    .status-message {
      padding: 15px;
      border-radius: 5px;
      margin-top: 20px;
      display: none;
    }
    .status-message.success {
      background-color: rgba(76, 175, 80, 0.1);
      color: var(--success-color);
      border: 1px solid var(--success-color);
    }
    .status-message.error {
      background-color: rgba(244, 67, 54, 0.1);
      color: var(--error-color);
      border: 1px solid var(--error-color);
    }
    .pending-appointments {
      margin-bottom: 30px;
    }
    .appointment-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    .appointment-table th,
    .appointment-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    .appointment-table th {
      background-color: var(--secondary-color);
      font-weight: 600;
    }
    .appointment-table tr:hover {
      background-color: rgba(106, 141, 146, 0.05);
      cursor: pointer;
    }
    .appointment-table tr.selected {
      background-color: rgba(106, 141, 146, 0.1);
      border-left: 3px solid var(--primary-color);
    }
    .hidden {
      display: none;
    }
    .loading {
      text-align: center;
      padding: 20px;
      color: var(--primary-color);
    }

    .info-message {
      padding: 15px;
      background-color: rgba(33, 150, 243, 0.1);
      color: #2196F3;
      border: 1px solid #2196F3;
      border-radius: 5px;
      margin-top: 15px;
    }
    @media (max-width: 600px) {
      .payment-methods {
        flex-direction: column;
      }
      .payment-method {
        width: 100%;
      }
      .appointment-table {
        font-size: 14px;
      }
      .appointment-table th,
      .appointment-table td {
        padding: 8px;
      }
    }
  </style>
</head>
<body>
<div class="container">
  <header>
    <h1>Hoàn thành thanh toán của bạn</h1>
  </header>

  <div class="payment-form">
    <!-- Pending Appointments Section -->
    <div class="pending-appointments" id="pending-appointments-section">
      <h3>Chọn một cuộc hẹn để thanh toán</h3>
      <p>Vui lòng chọn một trong các cuộc hẹn đang chờ xử lý bên dưới:</p>
      <div id="pending-appointments-list">
        <!-- Pending appointments will be loaded here -->
        <div class="loading">Loading appointments...</div>
      </div>
    </div>

    <!-- Payment Details Section (initially hidden) -->
    <div id="payment-details-section" class="hidden">
      <div class="summary">
        <h3>Appointment Summary</h3>
        <div id="appointment-details">
          <div class="summary-item">
            <span>Appointment ID:</span>
            <span id="appointment-id">--</span>
          </div>
          <div class="summary-item">
            <span>Customer:</span>
            <span id="customer-name">--</span>
          </div>
          <div class="summary-item">
            <span>Service:</span>
            <span id="service-name">--</span>
          </div>
          <div class="summary-item">
            <span>Date & Time:</span>
            <span id="appointment-datetime">--</span>
          </div>
          <div class="summary-item total">
            <span>Total Amount:</span>
            <span id="total-amount">--</span>
          </div>
        </div>
      </div>

      <h3>Payment Method</h3>
      <div class="payment-method selected">
        <img src="https://cdn-icons-png.flaticon.com/512/2489/2489756.png" alt="Cash">
        <div>Cash Payment</div>
      </div>
      <div class="form-group">
        <p>You have selected to pay with cash. Please confirm your payment to complete the booking.</p>
        <button id="confirm-payment" class="btn">Confirm Payment</button>
      </div>

      <div class="status-message success" id="success-message">
        Payment processed successfully! You will receive a confirmation email shortly.
      </div>
      <div class="status-message error" id="error-message">
        There was an error processing your payment. Please try again.
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const token = localStorage.getItem("token");
    if (!token) {
      alert("Vui lòng đăng nhập !!!");
      window.location.href = "/pages/login.html";
    }
    // DOM elements
    const pendingAppointmentsSection = document.getElementById('pending-appointments-section');
    const pendingAppointmentsList = document.getElementById('pending-appointments-list');
    const paymentDetailsSection = document.getElementById('payment-details-section');

    // Current selected appointment data
    let selectedAppointment = null;

    // Load pending appointments when the page loads
    loadPendingAppointments();

    // Function to load pending appointments
    function loadPendingAppointments() {
      fetch('https://skincare-booking-system.onrender.com/api/appointments', {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${getAuthToken()}`
        }
      })
              .then(response => {
                if (!response.ok) {
                  throw new Error('Failed to load appointments');
                }
                return response.json();
              })
              .then(appointments => {
                // Filter appointments with status "PENDING"
                const pendingAppointments = appointments.filter(app => app.status === 'CONFIRMED');
                displayPendingAppointments(pendingAppointments);
              })
              .catch(error => {
                pendingAppointmentsList.innerHTML = `
          <div class="error-message">
            Failed to load appointments. Please try again later.
          </div>
        `;
                console.error('Error:', error);
              });
    }

    // Function to display pending appointments
    function displayPendingAppointments(appointments) {
      if (!appointments || appointments.length === 0) {
        pendingAppointmentsList.innerHTML = `
      <div class="info-message">
        Không có các cuộc hẹn đang chờ xử lý yêu cầu thanh toán.
      </div>
    `;
        return;
      }

      // Map appointments to fetch service details
      const appointmentPromises = appointments.map(async appointment => {
        try {
          const response = await fetch(`https://skincare-booking-system.onrender.com/api/services/${appointment.serviceId}`, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${getAuthToken()}`
            }
          });

          if (!response.ok) {
            throw new Error('Failed to load service data');
          }

          const service = await response.json();
          return {
            ...appointment,
            price: service.price,
            serviceName: service.name
          };
        } catch (error) {
          console.error(`Error loading service for appointment ${appointment.id}:`, error);
          return {
            ...appointment,
            price: null,
            serviceName: 'Unknown Service'
          };
        }
      });

      // Wait for all appointments to be enriched with service info
      Promise.all(appointmentPromises).then(enrichedAppointments => {
        // Build the table
        let tableHTML = `
      <table class="appointment-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Customer</th>
            <th>Service</th>
            <th>Date & Time</th>
            <th>Price</th>
          </tr>
        </thead>
        <tbody>
    `;

        enrichedAppointments.forEach(appointment => {
          const formattedDate = new Date(appointment.appointmentDateTime).toLocaleString();
          const formattedPrice = appointment.price != null ? `$${appointment.price.toFixed(2)}` : 'N/A';

          tableHTML += `
        <tr data-id="${appointment.id}">
          <td>${appointment.id}</td>
          <td>${appointment.customerName || 'N/A'}</td>
          <td>${appointment.serviceName}</td>
          <td>${formattedDate}</td>
          <td>${formattedPrice}</td>
        </tr>
      `;
        });

        tableHTML += `
        </tbody>
      </table>
    `;

        pendingAppointmentsList.innerHTML = tableHTML;

        // Add event listeners to table rows
        document.querySelectorAll('.appointment-table tbody tr').forEach(row => {
          row.addEventListener('click', function () {
            document.querySelectorAll('.appointment-table tbody tr').forEach(r => r.classList.remove('selected'));
            this.classList.add('selected');

            const appointmentId = this.getAttribute('data-id');
            const appointmentData = enrichedAppointments.find(a => a.id == appointmentId);

            if (appointmentData) {
              selectedAppointment = appointmentData;
              displayAppointmentDetails(appointmentData);
            }
          });
        });
      });
    }


    // Function to display appointment details in the payment section
    function displayAppointmentDetails(appointment) {
      // Fill in appointment details
      document.getElementById('appointment-id').textContent = appointment.id;
      document.getElementById('customer-name').textContent = appointment.customerName || 'N/A';
      document.getElementById('service-name').textContent = appointment.serviceName;
      document.getElementById('appointment-datetime').textContent = new Date(appointment.appointmentDateTime).toLocaleString();
      document.getElementById('total-amount').textContent = `$${appointment.price.toFixed(2)}`;

      // Show payment details section and hide pending appointments
      pendingAppointmentsSection.classList.add('hidden');
      paymentDetailsSection.classList.remove('hidden');
    }

    // Add event listener to the confirm payment button
    document.getElementById('confirm-payment').addEventListener('click', function () {
      if (!selectedAppointment) {
        alert('Please select an appointment before confirming.');
        return;
      }

      // --- PHẦN SỬA ĐỔI ---
      const paymentRequest = {
        appointmentId: parseInt(selectedAppointment.id), // Ép kiểu về số nguyên (Long)
        amount: parseFloat(selectedAppointment.price),   // Ép kiểu về số thực (BigDecimal)
        paymentMethod: 'CASH'
        // XÓA DÒNG: status: 'CONFIRMED' -> Vì Backend tự set là PAID rồi, gửi lên sai enum sẽ bị lỗi 400
      };
      // --------------------

      // Gửi POST request tạo thanh toán
      fetch('https://skincare-booking-system.onrender.com/api/payment', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${getAuthToken()}`
        },
        body: JSON.stringify(paymentRequest)
      })
              .then(response => {
                if (!response.ok) {
                  // Đọc lỗi chi tiết từ server để dễ debug hơn
                  return response.text().then(text => { throw new Error(text) });
                }
                return response.json();
              })
              .then(data => {
                console.log('Payment successful:', data);

                // Sau khi thanh toán thành công, gọi API update trạng thái Appointment thành COMPLETED
                return fetch(`https://skincare-booking-system.onrender.com/api/appointments/${selectedAppointment.id}/complete`, {
                  method: 'PUT',
                  headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${getAuthToken()}`
                  }
                });
              })
              .then(updateResponse => {
                // ... phần xử lý phía sau giữ nguyên ...
                if (!updateResponse.ok) {
                  throw new Error('Failed to update appointment status');
                }
                return updateResponse.json();
              })
              .then(updatedAppointment => {
                // ... giữ nguyên ...
                document.getElementById('success-message').style.display = 'block';
                document.getElementById('error-message').style.display = 'none';
                setTimeout(() => {
                  window.location.href = 'booking.html'; // Hoặc chuyển hướng về trang lịch sử
                }, 3000);
              })
              .catch(error => {
                console.error('Error:', error);
                alert("Lỗi thanh toán: " + error.message); // Hiện thông báo lỗi rõ ràng
                document.getElementById('error-message').style.display = 'block';
                document.getElementById('success-message').style.display = 'none';
              });
    });



    // Function to create payment
    function createPayment(paymentRequest) {
      fetch('https://skincare-booking-system.onrender.com/api/payment', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${getAuthToken()}`
        },
        body: JSON.stringify(paymentRequest)
      })
              .then(response => {
                if (!response.ok) {
                  throw new Error('Payment request failed');
                }
                return response.json();
              })
              .then(data => {
                showSuccess('Payment confirmed successfully! Your booking is now complete.');
                // You can redirect to a confirmation page or booking history page
                setTimeout(() => {
                  window.location.href = '/bookings';
                }, 3000);
              })
              .catch(error => {
                showError('There was an error processing your payment. Please try again.');
                console.error('Error:', error);
              });
    }

    // Helper function to get auth token from localStorage
    function getAuthToken() {
      return localStorage.getItem('token') || '';
    }

    // Helper functions to show success and error messages
  });
</script>