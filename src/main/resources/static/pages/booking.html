<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒê·∫∑t L·ªãch</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Bungee+Tint&family=Dancing+Script:wght@400..700&family=Lobster&family=Noto+Serif:ital,wght@0,100..900;1,100..900&family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <style>
        /* Reset CSS */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Poppins", sans-serif;
        }
        body {
            color: #333;
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        /* ƒê·∫£m b·∫£o n·ªôi dung ch√≠nh chi·∫øm ph·∫ßn l·ªõn ƒë·ªÉ footer lu√¥n ·ªü cu·ªëi */
        main {
            flex-grow: 1;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 80px;
        }
        header, footer {
            background-color: rgb(245, 111, 133);
            padding: 15px 0;
            text-align: center;
            width: 100%;
            color: white;
        }
        header {
            top: 0;
            left: 0;
            z-index: 1000;
        }
        /*footer*/
        footer{
            background-color: rgb(245, 111, 133);
            color: white;
            text-align: center;
            padding: 20px;
            margin-top: 50px;
        }
        /* Navigation */
        nav ul {
            list-style: none;
            display: flex;
            justify-content: center;
            gap: 20px;
        }
        nav ul li a {
            color: white;
            text-decoration: none;
            font-weight: bold;
            padding: 10px;
            transition: 0.3s;
        }
        nav ul li a:hover {
            background-color: #e74c3c;
            border-radius: 5px;
        }
        /* Banner */
        .banner {
            width: 90%;
            max-width: 800px;
            margin-top: 50px;
            display: flex;
            justify-content: center;
            position: relative;
        }
        .banner img {
            width: 100%;
            border-radius: 10px;
            object-fit: cover;
            opacity: 0.8;
        }
        /* Form */
        form {
            background: rgba(255, 255, 255, 0.8);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
            width: 350px;
            text-align: center;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        label {
            font-weight: bold;
            display: block;
            margin-top: 10px;
        }
        input, select {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #e74c3c;
        }
        button {
            background-color: rgba(243, 105, 90, 0.9);
            color: white;
            border: 1px solid rgba(231, 76, 60, 0.5);
            padding: 10px 20px;
            margin-top: 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: 0.3s;
        }
        button:hover {
            background-color: rgba(246, 27, 3, 0.7);
        }
        /* Section */
        .anh-nen{
            background-image: url('../img/Cream Minimalist and Modern Cosmetics Product Presentation.png');
            background-color: rgb(137, 137, 137);
            background-blend-mode: multiply;
            background-position: center;
            background-attachment: fixed;
            width: 100%;
            height: 400px;
            position: relative;
            margin: 10px 10px;
            border-radius: 10px;
        }
        .h1{
            position: absolute;
            text-align: center;
            top: 150px;
            left: 27%;
            color: white;
            font-size: 40px;
        }
        .gioi-thieu h2{
            margin-top: 50px;
            font-size: 60px;
            font-family: "Dancing Script", cursive;
            color: #FF6699;
        }
        .h2-last{
            margin-top: 50px;
            font-size: 60px;
            font-family: "Dancing Script", cursive;
            color: #FF6699;
            margin-bottom: 50px;
        }
        .section {
            /* Kh·ªëi section n·∫±m gi·ªØa m√†n h√¨nh */
            width: 90%;
            max-width: 1000px;
            margin-left: 25%;
            /* N·ªôi dung b√™n trong s·∫Ω ƒë∆∞·ª£c cƒÉn l·ªÅ tr√°i */
            text-align: left;
        }
        .div-last h2{
            color: #FF6699;
        }
        .h1-first{
            font-family: "Lobster", sans-serif;
            font-size: 40px;
        }
        @media screen and (max-width: 480px) {
            form {
                width: 90%;
                top: 60%;
            }
            .h1 {
                font-size: 24px;
                top: 100px;
                left: 10%;
            }
            .gioi-thieu h2, .h2-last {
                font-size: 36px;
            }
        }
        .alert {
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 5px;
            text-align: center;
        }
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .user-info {
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
            text-align: left;
        }
        .user-info p {
            margin: 5px 0;
        }
        .user-info strong {
            font-weight: bold;
        }
    </style>
</head>
<body>
<header>
    <h1 class="h1-first">Miyazono Kaori</h1>
    <nav>
        <ul>
            <li><a href="../home.html">Trang Ch·ªß</a></li>
            <li><a href="../pages/services.html">D·ªãch V·ª•</a></li>
            <li><a href="../pages/about.html">Gi·ªõi Thi·ªáu</a></li>
            <li><a href="../pages/therapists.html">Chuy√™n Vi√™n</a></li>
            <li><a href="../pages/contact.html">Li√™n H·ªá</a></li>
            <li><a href="../pages/Payment.html">Thanh To√°n</a></li>
            <li id="logout-btn" style="display:none;"><a href="#" onclick="logout()">ƒêƒÉng xu·∫•t</a></li>
        </ul>
    </nav>
</header>

<div class="anh-nen">
    <h1 class="h1">Chuy√™n Gia Da Li·ªÖu H√†ng ƒê·∫ßu ‚Äì ƒê·∫£m B·∫£o Uy T√≠n & Hi·ªáu Qu·∫£</h1>
</div>

<div class="gioi-thieu">
    <h2>Booking Ngay!</h2>
</div>

<div class="banner">
    <img src="../img/now-booking.png" alt="Banner" />
    <form id="bookingForm">
        <!-- Hi·ªÉn th·ªã th√¥ng tin ng∆∞·ªùi d√πng ƒë√£ ƒëƒÉng nh·∫≠p -->
        <div id="userInfo" class="user-info">
            <p><strong>Kh√°ch h√†ng:</strong> <span id="customerName">ƒêang t·∫£i...</span></p>
            <p><strong>Email:</strong> <span id="customerEmail">ƒêang t·∫£i...</span></p>
        </div>

        <label for="appointmentDate">Ch·ªçn ng√†y h·∫πn:</label>
        <input type="date" id="appointmentDate" name="appointmentDate" required>

        <label for="appointmentTime">Th·ªùi gian h·∫πn:</label>
        <input type="time" id="appointmentTime" name="appointmentTime" required>

        <label for="serviceId">Ch·ªçn d·ªãch v·ª•:</label>
        <select id="serviceId" name="serviceId" required>
            <option value="">-- Ch·ªçn d·ªãch v·ª• --</option>
        </select>

        <label for="specialistId">Ch·ªçn chuy√™n vi√™n:</label>
        <select id="specialistId" name="specialistId" required>
            <option value="">-- Ch·ªçn chuy√™n vi√™n --</option>
        </select>

        <button type="submit">ƒê·∫∑t l·ªãch</button>
        <button type="reset">X√≥a l·ª±a ch·ªçn</button>
    </form>
</div>

<br> <br>
<hr style="width : 50%; margin: auto;">

<div>
    <h2 class="h2-last">Ch√∫ng t√¥i ƒë·∫£m b·∫£o ch·∫•t l∆∞·ª£ng l√™n h√†ng ƒê·∫ßu</h2>
</div>

<section class="section">
    <div class="div-last">
        <h2>1. ƒê·ªôi Ng≈© Chuy√™n Gia H√†ng ƒê·∫ßu</h2>
        <article>
            <ul>
                <li>H∆°n 15 nƒÉm kinh nghi·ªám trong lƒ©nh v·ª±c chƒÉm s√≥c v√† ƒëi·ªÅu tr·ªã da chuy√™n s√¢u.</li>
                <li>ƒê∆∞·ª£c ch·ª©ng nh·∫≠n b·ªüi Hi·ªáp h·ªôi Da Li·ªÖu Qu·ªëc T·∫ø, ƒë·∫£m b·∫£o quy tr√¨nh ƒëi·ªÅu tr·ªã chu·∫©n y khoa.</li>
                <li> ƒê·ªôi ng≈© chuy√™n gia t·ª´ng t∆∞ v·∫•n v√† c·ªông t√°c v·ªõi c√°c th∆∞∆°ng hi·ªáu m·ªπ ph·∫©m h√†ng ƒë·∫ßu th·∫ø gi·ªõi.</li>
            </ul>
        </article>
    </div>
    <div class="div-last">
        <h2>2. Th√†nh T·ª±u N·ªïi B·∫≠t</h2>
        <article>
            <ul>
                <li>ƒê√£ ƒëi·ªÅu tr·ªã th√†nh c√¥ng h∆°n 5.000 kh√°ch h√†ng, gi√∫p h·ªç l·∫•y l·∫°i l√†n da kh·ªèe m·∫°nh, m·ªãn m√†ng. </li>
                <li>Chuy√™n gia trong c√°c ph∆∞∆°ng ph√°p tr·ªã li·ªáu ti√™n ti·∫øn nh∆∞:</li>
                <li>Li·ªáu tr√¨nh tr·∫ª h√≥a da HIFU ‚Äì n√¢ng c∆°, ch·ªëng l√£o h√≥a hi·ªáu qu·∫£.</li>
                <li>ƒêi·ªÅu tr·ªã n√°m ‚Äì t√†n nhang b·∫±ng c√¥ng ngh·ªá laser.</li>
                <li>ƒêi·ªán di vitamin C gi√∫p da tr·∫Øng s√°ng, cƒÉng b√≥ng t·ª± nhi√™n. </li>
                <li>ChƒÉm s√≥c da chuy√™n s√¢u v·ªõi ph√°c ƒë·ªì c√° nh√¢n h√≥a.</li>
            </ul>
        </article>
    </div>
    <div class="div-last">
        <h2>3. Cam K·∫øt & Ch·∫•t L∆∞·ª£ng</h2>
        <article>
            <ul>
                <li>T∆∞ v·∫•n 1:1 chuy√™n s√¢u v·ªõi chuy√™n gia, ƒë∆∞a ra l·ªô tr√¨nh ƒëi·ªÅu tr·ªã ph√π h·ª£p nh·∫•t.</li>
                <li>S·ª≠ d·ª•ng c√¥ng ngh·ªá hi·ªán ƒë·∫°i, cam k·∫øt an to√†n tuy·ªát ƒë·ªëi.</li>
                <li>100% kh√°ch h√†ng h√†i l√≤ng v·ªõi k·∫øt qu·∫£ sau li·ªáu tr√¨nh.</li>
            </ul>
            <b>üîπ H√£y ƒë·∫∑t l·ªãch ngay h√¥m nay ƒë·ªÉ ƒë∆∞·ª£c t∆∞ v·∫•n mi·ªÖn ph√≠ v√† tr·∫£i nghi·ªám d·ªãch v·ª• chƒÉm s√≥c da chuy√™n nghi·ªáp!</b>
        </article>
    </div>
</section>

<br> <br> <br> <br> <br> <br>

<footer>
    <p>&copy; M·ªçi th·∫Øc m·∫Øc ho·∫∑c khi·∫øu n·∫°i c·ªßa kh√°ch h√†ng t·∫°i Email: loclc8533@ut.edu.vn</p>
</footer>

<script>

    // Bi·∫øn l∆∞u tr·ªØ th√¥ng tin ng∆∞·ªùi d√πng hi·ªán t·∫°i
    let currentUser = null;
    let customerId = null;
    // ch·ªçn chuy√™n vi√™n t·ª´ tham s·ªë
    function selectSpecialist(specialistId, specialistName) {
        const specialistSelect = document.getElementById('specialistId');
        const options = specialistSelect.options;

        for (let i = 0; i < options.length; i++) {
            if (options[i].value == specialistId) {
                specialistSelect.selectedIndex = i;
                break;
            }
        }

        // N·∫øu kh√¥ng t√¨m th·∫•y ID trong danh s√°ch, th√™m t√πy ch·ªçn m·ªõi
        if (specialistSelect.value !== specialistId && specialistId) {
            const option = document.createElement('option');
            option.value = specialistId;
            option.textContent = `${specialistName || 'Chuy√™n vi√™n ƒë√£ ch·ªçn'}`;
            option.selected = true;
            specialistSelect.appendChild(option);
        }

        // Sau khi ch·ªçn, x√≥a th√¥ng tin t·ª´ localStorage ƒë·ªÉ tr√°nh ·∫£nh h∆∞·ªüng ƒë·∫øn c√°c l·∫ßn ƒë·∫∑t l·ªãch ti·∫øp theo
        localStorage.removeItem('selectedSpecialistId');
        localStorage.removeItem('selectedSpecialistName');
    }


    // H√†m ƒë·ªÉ l·∫•y d·ªãch v·ª• t·ª´ API v√† ƒëi·ªÅn v√†o dropdown d·ªãch v·ª•
    function fetchAndPopulateServices() {
        const serviceDropdown = document.getElementById('serviceId');
        // X√≥a c√°c t√πy ch·ªçn hi·ªán c√≥ tr·ª´ placeholder
        while (serviceDropdown.options.length > 1) {
            serviceDropdown.remove(1);
        }

        // L·∫•y token x√°c th·ª±c t·ª´ localStorage
        const token = localStorage.getItem('token');

        // G·ªçi API ƒë·ªÉ l·∫•y danh s√°ch d·ªãch v·ª•
        fetch('http://localhost:8080/api/services', {
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            },
            credentials: 'include'
        })
            .then(response => {
                // Ki·ªÉm tra ph·∫£n h·ªìi t·ª´ server
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        throw new Error('Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n');
                    }
                    throw new Error('Kh√¥ng th·ªÉ l·∫•y danh s√°ch d·ªãch v·ª•');
                }
                return response.json();
            })
            .then(services => {
                // Th√™m t·ª´ng d·ªãch v·ª• v√†o dropdown
                services.forEach(service => {
                    const option = document.createElement('option');
                    option.value = service.id; // S·ª≠ d·ª•ng ID c·ªßa d·ªãch v·ª• l√†m gi√° tr·ªã
                    option.textContent = service.name; // S·ª≠ d·ª•ng t√™n d·ªãch v·ª• ƒë·ªÉ hi·ªÉn th·ªã
                    serviceDropdown.appendChild(option);
                });
            })
            .catch(error => {
                console.error('L·ªói khi l·∫•y danh s√°ch d·ªãch v·ª•:', error);
                // X·ª≠ l√Ω tr∆∞·ªùng h·ª£p phi√™n ƒëƒÉng nh·∫≠p h·∫øt h·∫°n
                if (error.message === 'Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n') {
                    localStorage.removeItem('token');
                    alert('Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.');
                    window.location.href = 'login.html';
                }
            });
    }

    // H√†m ƒë·ªÉ l·∫•y danh s√°ch chuy√™n vi√™n t·ª´ API v√† ƒëi·ªÅn v√†o dropdown
    function fetchAndPopulateSpecialists() {
        const specialistDropdown = document.getElementById('specialistId');
        // X√≥a c√°c t√πy ch·ªçn hi·ªán c√≥ tr·ª´ placeholder
        while (specialistDropdown.options.length > 1) {
            specialistDropdown.remove(1);
        }

        // L·∫•y token x√°c th·ª±c t·ª´ localStorage
        const token = localStorage.getItem('token');

        // G·ªçi API ƒë·ªÉ l·∫•y danh s√°ch chuy√™n gia/b√°c sƒ©
        fetch('http://localhost:8080/api/specialists', {
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            },
            credentials: 'include'
        })
            .then(response => {
                // Ki·ªÉm tra ph·∫£n h·ªìi t·ª´ server
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        throw new Error('Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n');
                    }
                    throw new Error('Kh√¥ng th·ªÉ l·∫•y danh s√°ch chuy√™n vi√™n');
                }
                return response.json();
            })
            .then(specialists => {
                // Th√™m t·ª´ng chuy√™n gia v√†o dropdown
                specialists.forEach(specialist => {
                    const option = document.createElement('option');
                    option.value = specialist.id;
                    // S·ª≠ d·ª•ng t√™n ƒë·∫ßy ƒë·ªß t·ª´ ƒë·ªëi t∆∞·ª£ng user
                    if (specialist.user && specialist.user.fullName) {
                        option.textContent = specialist.user.fullName;
                    } else {
                        // Tr∆∞·ªùng h·ª£p d·ª± ph√≤ng n·∫øu c·∫•u tr√∫c kh√¥ng nh∆∞ mong ƒë·ª£i
                        option.textContent = `Chuy√™n vi√™n ID: ${specialist.id}`;
                    }
                    // Th√™m th√¥ng tin chuy√™n m√¥n n·∫øu c√≥
                    if (specialist.expertise) {
                        option.textContent += ` - ${specialist.expertise}`;
                    }
                    // Th√™m s·ªë nƒÉm kinh nghi·ªám n·∫øu c√≥
                    if (specialist.experience !== undefined && specialist.experience !== null) {
                        option.textContent += ` (${specialist.experience} nƒÉm KN)`;
                    }
                    specialistDropdown.appendChild(option);
                });
            })
            .catch(error => {
                console.error('L·ªói khi l·∫•y danh s√°ch chuy√™n vi√™n:', error);
                // X·ª≠ l√Ω tr∆∞·ªùng h·ª£p phi√™n ƒëƒÉng nh·∫≠p h·∫øt h·∫°n
                if (error.message === 'Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n') {
                    localStorage.removeItem('token');
                    alert('Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.');
                    window.location.href = 'login.html';
                }
            });
    }

    // H√†m l·∫•y th√¥ng tin ng∆∞·ªùi d√πng hi·ªán t·∫°i
    function fetchCurrentUserInfo() {
        const token = localStorage.getItem('token');
        fetch("http://localhost:8080/api/users/me", {
            method: "GET",
            headers: {
                "Authorization": "Bearer " + token,
                "Content-Type": "application/json"
            },
            credentials: "include"
        })
            .then(response => {
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        localStorage.removeItem('token');
                        alert('Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.');
                        window.location.href = 'login.html';
                        throw new Error('Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n');
                    }
                    throw new Error('Kh√¥ng th·ªÉ l·∫•y th√¥ng tin ng∆∞·ªùi d√πng');
                }
                return response.json();
            })
            .then(userData => {
                // L∆∞u th√¥ng tin ng∆∞·ªùi d√πng
                currentUser = userData;

                // Hi·ªÉn th·ªã th√¥ng tin ng∆∞·ªùi d√πng trong form
                document.getElementById('customerName').textContent = userData.fullName || 'Kh√¥ng c√≥ th√¥ng tin';
                document.getElementById('customerEmail').textContent = userData.email || 'Kh√¥ng c√≥ th√¥ng tin';

                // L·∫•y customerId t·ª´ th√¥ng tin ng∆∞·ªùi d√πng
                if (userData.id) {
                    customerId = userData.id;
                } else {
                    // N·∫øu kh√¥ng c√≥ th√¥ng tin customer, c·∫ßn l·∫•y th√¥ng tin t·ª´ API kh√°c
                    fetchCustomerInfo(userData.id);
                }
            })
            .catch(error => {
                console.error("L·ªói khi l·∫•y th√¥ng tin ng∆∞·ªùi d√πng:", error);
                if (error.message !== 'Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n') {
                    // Hi·ªÉn th·ªã th√¥ng b√°o l·ªói n·∫øu kh√¥ng ph·∫£i l·ªói h·∫øt h·∫°n ƒëƒÉng nh·∫≠p
                    const errorMessage = document.createElement('div');
                    errorMessage.className = 'alert alert-danger';
                    errorMessage.textContent = "Kh√¥ng th·ªÉ l·∫•y th√¥ng tin ng∆∞·ªùi d√πng. Vui l√≤ng t·∫£i l·∫°i trang.";
                    document.getElementById("bookingForm").prepend(errorMessage);
                    setTimeout(() => {
                        errorMessage.remove();
                    }, 5000);
                }
            });
    }

    //h√†m l·∫•y th√¥ng tin ng d√πng t·ª´ id
    function fetchCustomerInfo(id){
        const token = localStorage.getItem('token')

        fetch("http://localhost:8080/api/users/{id}",{
            method: "GET",
            header:{
                "Authorization" : "Bearer" + token,
                "Content-Type" : "application/json"
            },
            credentials:"include"

        })
            .then(response => {
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        localStorage.removeItem('token');
                        alert('Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.');
                        window.location.href = 'login.html';
                        throw new Error('Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n');
                    }
                    throw new Error('Kh√¥ng th·ªÉ l·∫•y th√¥ng tin ng∆∞·ªùi d√πng');
                }
                return response.json();
            })
            .then(customerData =>  {
                customerId = customerData.id;
            })
            .catch(error => {
                console.error("L·ªói khi l·∫•y th√¥ng tin kh√°ch h√†ng:", error);
                const errorMessage = document.createElement('div');
                errorMessage.className = 'alert alert-danger';
                errorMessage.textContent = "Kh√¥ng th·ªÉ l·∫•y th√¥ng tin kh√°ch h√†ng. Vui l√≤ng li√™n h·ªá qu·∫£n tr·ªã vi√™n.";
                document.getElementById("bookingForm").prepend(errorMessage);
                setTimeout(() => {
                    errorMessage.remove();
                }, 5000);
            });
    }

    // H√†m kh·ªüi t·∫°o c·∫£ hai dropdown
    function initializeDropdowns() {
        // L·∫•y reference ƒë·∫øn c√°c dropdown
        const serviceDropdown = document.getElementById('dich_vu');
        const specialistDropdown = document.getElementById('bac_si');

        if (serviceDropdown && specialistDropdown) {
            // X√≥a t·∫•t c·∫£ t√πy ch·ªçn hi·ªán c√≥
            serviceDropdown.innerHTML = '';
            specialistDropdown.innerHTML = '';

            // Th√™m t√πy ch·ªçn placeholder cho dropdown d·ªãch v·ª•
            const servicePlaceholder = document.createElement('option');
            servicePlaceholder.value = '';
            servicePlaceholder.textContent = '-- Ch·ªçn d·ªãch v·ª• --';
            servicePlaceholder.disabled = true;
            servicePlaceholder.selected = true;
            serviceDropdown.appendChild(servicePlaceholder);

            // Th√™m t√πy ch·ªçn placeholder cho dropdown b√°c sƒ©
            const specialistPlaceholder = document.createElement('option');
            specialistPlaceholder.value = '';
            specialistPlaceholder.textContent = '-- Ch·ªçn b√°c sƒ© --';
            specialistPlaceholder.disabled = true;
            specialistPlaceholder.selected = true;
            specialistDropdown.appendChild(specialistPlaceholder);

            // G·ªçi c√°c h√†m ƒë·ªÉ l·∫•y d·ªØ li·ªáu v√† ƒëi·ªÅn v√†o dropdown
            fetchAndPopulateServices();
            fetchAndPopulateSpecialists();
        }
    }

    // H√†m x·ª≠ l√Ω ƒëƒÉng xu·∫•t
    function logout() {
        localStorage.removeItem("token");
        localStorage.removeItem("selectedSpecialistId");
        localStorage.removeItem("selectedSpecialistName");
        window.location.href = "login.html";
    }

    function checkSpecialistAvailability(specialistId, appointmentDateTime) {
        const token = localStorage.getItem('token');

        // T·∫°o URL v·ªõi tpham s·ªë truy v·∫•n
        const url = `http://localhost:8080/api/appointments/check-availability?specialistId=${specialistId}&appointmentDateTime=${encodeURIComponent(appointmentDateTime)}`;

        return fetch(url, {
            method: "GET",
            headers: {
                "Authorization": "Bearer " + token,
                "Content-Type": "application/json"
            },
            credentials: "include"
        })
            .then(response => {
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        localStorage.removeItem('token');
                        alert('Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.');
                        window.location.href = 'login.html';
                        throw new Error('Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n');
                    }
                    throw new Error('Kh√¥ng th·ªÉ ki·ªÉm tra t√≠nh kh·∫£ d·ª•ng c·ªßa chuy√™n vi√™n');
                }
                return response.json();
            })
            .then(data => {
                // Gi·∫£ s·ª≠ API tr·∫£ v·ªÅ { available: true/false }
                return data.available;
            });
    }

    function showMessage(message, type = 'danger') {
        // X√≥a t·∫•t c·∫£ th√¥ng b√°o hi·ªán c√≥
        const existingAlerts = document.querySelectorAll('.alert');
        existingAlerts.forEach(alert => alert.remove());

        // T·∫°o ph·∫ßn t·ª≠ th√¥ng b√°o m·ªõi
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type}`;
        alertDiv.textContent = message;

        // Th√™m v√†o form
        document.getElementById("bookingForm").prepend(alertDiv);

        // T·ª± ƒë·ªông ·∫©n sau 5 gi√¢y
        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    }
    // G·ªçi h√†m kh·ªüi t·∫°o khi trang ƒë∆∞·ª£c t·∫£i
    document.addEventListener('DOMContentLoaded', () => {
        // Ki·ªÉm tra xem ng∆∞·ªùi d√πng ƒë√£ ƒëƒÉng nh·∫≠p ch∆∞a
        const token = localStorage.getItem('token');
        if (!token) {
            // N·∫øu ch∆∞a ƒëƒÉng nh·∫≠p, hi·ªÉn th·ªã th√¥ng b√°o v√† chuy·ªÉn h∆∞·ªõng
            alert('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ƒë·∫∑t l·ªãch.');
            window.location.href = 'login.html';
            return;
        } else {
            // N·∫øu ƒë√£ ƒëƒÉng nh·∫≠p, hi·ªÉn th·ªã n√∫t ƒëƒÉng xu·∫•t
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) logoutBtn.style.display = 'inline';

            // L·∫•y th√¥ng tin ng∆∞·ªùi d√πng v√† kh·ªüi t·∫°o c√°c dropdown
            fetchCurrentUserInfo();
            fetchAndPopulateServices();
            fetchAndPopulateSpecialists();

            // Ki·ªÉm tra n·∫øu c√≥ chuy√™n vi√™n ƒë∆∞·ª£c ch·ªçn t·ª´ trang chuy√™n vi√™n
            const selectedSpecialistId = localStorage.getItem('selectedSpecialistId');
            const selectedSpecialistName = localStorage.getItem('selectedSpecialistName');
            if (selectedSpecialistId) {
                // D√πng setTimeout ƒë·ªÉ ƒë·∫£m b·∫£o danh s√°ch chuy√™n vi√™n ƒë√£ ƒë∆∞·ª£c t·∫£i
                setTimeout(() => {
                    selectSpecialist(selectedSpecialistId, selectedSpecialistName);
                }, 1000);
            }

            // X·ª≠ l√Ω s·ª± ki·ªán submit form ƒë·∫∑t l·ªãch
            const bookingForm = document.getElementById('bookingForm');
            if (bookingForm) {
                bookingForm.addEventListener('submit', function(e) {
                    e.preventDefault(); // NgƒÉn ch·∫∑n h√†nh vi m·∫∑c ƒë·ªãnh c·ªßa form

                    // Ki·ªÉm tra xem ƒë√£ c√≥ customerId ch∆∞a
                    if (!customerId) {
                        alert('Kh√¥ng th·ªÉ x√°c ƒë·ªãnh th√¥ng tin kh√°ch h√†ng. Vui l√≤ng t·∫£i l·∫°i trang ho·∫∑c li√™n h·ªá qu·∫£n tr·ªã vi√™n.');
                        return;
                    }

                    // L·∫•y d·ªØ li·ªáu t·ª´ form
                    const appointmentDate = document.getElementById('appointmentDate').value;
                    const appointmentTime = document.getElementById('appointmentTime').value;
                    const serviceId = document.getElementById('serviceId').value;
                    const specialistId = document.getElementById('specialistId').value;

                    // Ki·ªÉm tra n·∫øu c√°c tr∆∞·ªùng b·∫Øt bu·ªôc ch∆∞a ƒë∆∞·ª£c ƒëi·ªÅn
                    if (!appointmentDate || !appointmentTime || !serviceId || !specialistId) {
                        alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin.');
                        return;
                    }

                    // K·∫øt h·ª£p ng√†y v√† gi·ªù th√†nh chu·ªói ISO datetime
                    const appointmentDateTime = `${appointmentDate}T${appointmentTime}:00`;

                    // Hi·ªÉn th·ªã tr·∫°ng th√°i ƒëang x·ª≠ l√Ω tr√™n n√∫t submit
                    const submitBtn = document.querySelector('button[type="submit"]');
                    const originalBtnText = submitBtn.textContent;
                    submitBtn.disabled = true;
                    submitBtn.textContent = "ƒêang x·ª≠ l√Ω...";

                    // Ki·ªÉm tra t√≠nh kh·∫£ d·ª•ng c·ªßa chuy√™n vi√™n tr∆∞·ªõc khi ƒë·∫∑t l·ªãch
                    checkSpecialistAvailability(specialistId, appointmentDateTime)
                        .then(isAvailable => {
                            // 1. LOGIC KI·ªÇM TRA L·ªäCH
                            if (isAvailable === false) { // So s√°nh t∆∞·ªùng minh
                                showMessage("B√°c sƒ© ƒë√£ c√≥ l·ªãch h·∫πn v√†o th·ªùi gian n√†y. Vui l√≤ng ch·ªçn th·ªùi gian kh√°c.", "danger");

                                // Reset gi·ªù v√† n√∫t b·∫•m
                                document.getElementById('appointmentTime').value = '';
                                if(submitBtn) {
                                    submitBtn.disabled = false;
                                    submitBtn.textContent = originalBtnText;
                                }

                                // Ng·∫Øt chu·ªói Promise
                                throw new Error("CONFLICT_SCHEDULE");
                            }

                            // 2. LOGIC ƒê·∫∂T L·ªäCH (Khi b√°c sƒ© r·∫£nh)
                            const appointmentData = {
                                customerId: customerId,
                                specialistId: parseInt(specialistId),
                                serviceId: parseInt(serviceId),
                                appointmentDate: appointmentDateTime,
                                status: "PENDING"
                            };

                            const token = localStorage.getItem('token');

                            return fetch("http://localhost:8080/api/appointments", {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                    "Authorization": "Bearer " + token
                                },
                                body: JSON.stringify(appointmentData)
                            });
                        })
                        .then(async response => {
                            // 3. X·ª¨ L√ù K·∫æT QU·∫¢ TR·∫¢ V·ªÄ
                            if (!response.ok) {
                                // X·ª≠ l√Ω l·ªói 401/403 (H·∫øt phi√™n)
                                if (response.status === 401 || response.status === 403) {
                                    localStorage.removeItem('token');
                                    window.location.href = 'login.html';
                                    throw new Error('Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n');
                                }

                                // X·ª≠ l√Ω ƒë·ªçc l·ªói an to√†n (D√π server tr·∫£ v·ªÅ Text hay JSON ƒë·ªÅu ƒë·ªçc ƒë∆∞·ª£c)
                                const errorText = await response.text();
                                try {
                                    // C·ªë g·∫Øng parse JSON n·∫øu c√≥ th·ªÉ
                                    const errorJson = JSON.parse(errorText);
                                    throw new Error(errorJson.message || errorText);
                                } catch (e) {
                                    // N·∫øu kh√¥ng ph·∫£i JSON, d√πng text thu·∫ßn
                                    throw new Error(errorText || "C√≥ l·ªói khi g·ª≠i ƒë·∫∑t l·ªãch");
                                }
                            }
                            return response.json();
                        })
                        .then(data => {
                            // 4. TH√ÄNH C√îNG
                            showMessage("ƒê·∫∑t l·ªãch th√†nh c√¥ng! Ch√∫ng t√¥i s·∫Ω li√™n h·ªá v·ªõi b·∫°n qua email.", "success");

                            // Reset form
                            if(document.getElementById('appointmentDate')) {
                                document.getElementById('appointmentDate').value = tomorrowFormatted;
                            }
                            document.getElementById('appointmentTime').value = '';
                            document.getElementById('serviceId').selectedIndex = 0;
                            // document.getElementById('specialistId').selectedIndex = 0; // C√≥ th·ªÉ gi·ªØ l·∫°i b√°c sƒ© ƒë·ªÉ user ƒë·∫∑t ti·∫øp n·∫øu mu·ªën
                        })
                        .catch(error => {
                            console.error("L·ªói chi ti·∫øt:", error);

                            // 5. HI·ªÇN TH·ªä L·ªñI CH√çNH X√ÅC
                            if (error.message === "CONFLICT_SCHEDULE") {
                                showMessage("ƒê·∫∑t l·ªãch kh√¥ng th√†nh c√¥ng! do l·ªãch hi·ªán t·∫°i b·∫°n ch·ªçn kh√¥ng c√≤n tr·ªëng", "failed");
                                // L·ªói do m√¨nh t·ª± n√©m ·ªü b∆∞·ªõc 1, kh√¥ng c·∫ßn l√†m g√¨ th√™m v√¨ ƒë√£ showMessage r·ªìi
                                return;
                            }

                            if (error.message === 'Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n') {
                                alert(error.message);
                                return;
                            }

                            // Hi·ªÉn th·ªã l·ªói th·ª±c t·∫ø t·ª´ Server gi√∫p b·∫°n d·ªÖ debug
                            let displayMsg = error.message;
                            if(displayMsg === 'Failed to fetch') displayMsg = "Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn Server";

                            showMessage("L·ªói: " + displayMsg, "danger");
                        })
                        .finally(() => {
                            // 6. LU√îN M·ªû L·∫†I N√öT B·∫§M
                            if (submitBtn) {
                                submitBtn.disabled = false;
                                submitBtn.textContent = originalBtnText;
                            }
                        });

                });
            }
        }

        // Thi·∫øt l·∫≠p gi√° tr·ªã m·∫∑c ƒë·ªãnh cho ng√†y ƒë·∫∑t l·ªãch (ng√†y hi·ªán t·∫°i + 1 ng√†y)
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        const tomorrowFormatted = tomorrow.toISOString().split('T')[0];
        document.getElementById('appointmentDate').min = tomorrowFormatted;
        document.getElementById('appointmentDate').value = tomorrowFormatted;
    });
</script>

</body>
</html>